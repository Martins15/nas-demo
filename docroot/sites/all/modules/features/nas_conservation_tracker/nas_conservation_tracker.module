<?php
/**
 * @file
 * Code for the NAS Conservation Tracker feature.
 */

include_once 'nas_conservation_tracker.features.inc';

/**
 * Implements hook_ctools_plugin_directory().
 */
function nas_conservation_tracker_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_init().
 */
function nas_conservation_tracker_init() {

  $sections = arg();
  $path = array_pop($sections);
  $types = variable_get('nas_conservation_tracker_tabs', array('threats', 'actions', 'responses', 'partners'));

  if (in_array($path, $types)) {
    $alias = implode('/', $sections);
    $source = drupal_get_normal_path($alias);
    menu_execute_active_handler($source);
    drupal_exit();
  }


  //@todo need correct include js file.
  drupal_add_js('//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.min.js', 'external');
  drupal_add_js('//unpkg.com/angular-ui-router@0.3.2/release/angular-ui-router.min.js', 'external');
  drupal_add_js('//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-sanitize.min.js', 'external');
  drupal_add_js('//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-cookies.min.js', 'external');
  drupal_add_js('//ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-animate.min.js', 'external');
  drupal_add_js('//cdnjs.cloudflare.com/ajax/libs/ngStorage/0.3.11/ngStorage.min.js', 'external');
  drupal_add_js('//cdnjs.cloudflare.com/ajax/libs/angular-scroll/1.0.0/angular-scroll.min.js', 'external');
  $js_path = drupal_get_path('module', 'nas_conservation_tracker') . '/js/';
  drupal_add_js($js_path . 'ct_tabs.js');
  drupal_add_js($js_path . 'nas_conservation_tracker.js', array(
    'weight' => 999,
    'group' => JS_THEME,
  ));
}

/**
 * Implements hook_menu().
 */
function nas_conservation_tracker_menu() {
  $items = array();
  $items['conservation-tracker/ajax/scorecard/%/%'] = array (
    'title' => 'Get data for scorecard',
    'page callback' => 'nas_conservation_tracker_get_scorecard_json',
    'page arguments' => array(3,4),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_libraries_info().
 */
function nas_conservation_tracker_libraries_info() {
  $libraries = array();

  $lib_info = array(
    'vendor url' => 'http://audubon.org',
    'path' => 'js',
    'library path' => drupal_get_path('module', 'nas_conservation_tracker'),
    'dependencies' => array('d3'),
    'version' => '1',
  );

  $libs = array(
    'ct_linegraph' => 'CT Line Graph',
    'ct_circular' => 'CT Circular',
  );

  foreach ($libs as $filename => $name) {
    $key = 'd3.' . $filename;
    $libraries[$key] = $lib_info;
    $libraries[$key]['files']['js'][] = $filename . '.js';
  }

  return $libraries;
}

/**
 * Implements hook_libraries_info_alter().
 */
function nas_conservation_tracker_libraries_info_alter(&$libraries) {
  $libraries['leaflet']['version arguments']['lines'] = 137000;
  $libraries['leaflet']['version arguments']['cols'] = 150000;
}

/**
 * Implements hook_theme().
 */
function nas_conservation_tracker_theme() {
  $theme = array(
    'ct_scorecard_header' => array(
      'variables' => array(
        'name' => NULL,
        'subtitle' => NULL,
        'image' => NULL,
        'description' => NULL,
      ),
      'template' => 'templates/ct-scorecard-header',
    ),
    'ct_scorecard_tabs' => array(
      'variables' => array(
        'menu_tree' => NULL,
        'tabs' => NULL,
      ),
      'template' => 'templates/ct-scorecard-tabs',
    ),
    'ct_scorecard_tabs' => array(
      'variables' => array(
        'menu_tree' => NULL,
        'tabs' => NULL,
      ),
      'template' => 'templates/ct-scorecard-tabs',
    ),
    'ct_scorecard_overview' => array(
      'variables' => array(
        'title' => NULL,
        'description' => NULL,
        'media' => NULL,
      ),
      'template' => 'templates/ct-scorecard-overview',
    ),
    'ct_scorecard_main' => array(
      'variables' => array(
        'map' => NULL,
      ),
      'template' => 'templates/ct-scorecard-main',
    ),
    'ct_scorecard_carousel' => array(
      'variables' => array(
        'title' => NULL,
        'items' => NULL,
      ),
      'template' => 'templates/ct-scorecard-carousel',
    ),
  );
  return $theme;
}

/**
 * Get JSON object from hub.
 * @param $path
 */
function nas_conservation_tracker_get_json($path) {
  // @TODO: swap this for real data hub.
  $demo_url = '';
  $json_data = NULL;
  if (variable_get('nas_conservation_tracker_api_cache_enabled', TRUE)) {
    $cid = 'nas_conservation_tracker:' . md5($path);
    $data = cache_get($cid);
    if (!empty($data->data)) {
      $json_data = $data->data;
    }
  }

  if (empty($json_data)) {
    $json_url = rtrim(variable_get('nas_conservation_tracker_endpoint', $demo_url), '\/') . '/' . $path . '.json';
    $request = drupal_http_request($json_url);
    $json_data = drupal_json_decode($request->data);
    if (variable_get('nas_conservation_tracker_api_cache_enabled', TRUE)) {
      cache_set($cid, $json_data);
    }
  }
  return $json_data;
}

/**
 * Get Score card data.
 * @param $id
 */
function nas_conservation_tracker_get_scorecard_json($id, $type = 'actions') {
  $result = array('data' => array(), success => 0);
  if (!empty($id) && is_numeric($id)) {
    $data = nas_conservation_tracker_get_json('scorecard-' . $id);
    $types = variable_get('nas_conservation_tracker_tabs', array('threats', 'actions', 'responses', 'partners'));
    if (!in_array($type, $types)) {
      $type = 'actions';
    }
    foreach ($types as $item) {
      if ($item != $type) {
        unset($data[$item]);
      }
    }

    $result['data'] = $data;
    if (!empty($result['data'])) {
      $result['success'] = 1;
    }
  }
  drupal_json_output($result);
}
